<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<script>
	dojoConfig = {
		isDebug: false,
		async: true,
		djeoEngine: "djeo",
		packages: [
			{name:"race", location: "../../djeo-demos/race"}
		]
	};
</script>
<script src="../util.js"></script>
<script src="../../dojo/dojo.js"></script>

<script>

var numCars = 20,
	carDistance = 50
;

require([
	"djeo/Map",
	"djeo/control/Navigation",
	"djeo/control/Highlight",
	"race/RaceServer",
	"race/RaceClient",
	"track.js",
	"djeo/Model",
	"dojo/domReady!"
], function(Map, Navigation, Highlight, RaceServer, RaceClient, trackCoords) {
	
	var server = new RaceServer({
		trackCoords: trackCoords,
		numCars: numCars,
		carDistance: carDistance,
		speed: 14 // ~50 km/h
	});
	
	var carPositions = server.getInitialCarPositions();
	
	var features = [];
	for(var i=0; i<numCars; i++) {
		features.push({
			id: i+1,
			type: "Model",
			coords: carPositions[i][0],
			href: "resources/mercedes1904.kmz",
			style: {
				img: "resources/mercedes1904.png",
				size: [32,32]
			},
			orientation: carPositions[i][1]
		});
	}
	
	var e = dojoConfig.djeoEngine,
		layers = (e=="djeo" || e=="leaflet" || e=="esri") ? "osm" : "SATELLITE"
	;

	var map = new Map("map", {
		features: features,
		layers: "osm",
		renderModels: true,
		extent: [8.564, 49.3256, 8.584, 49.333],
		// Leaflet, Google Maps API, Yandex Maps API don't support icon orientation natively
		// However, it's possible to simulate it via pre-generated sprites
		simulateOrientation: true
	});
	map.ready(function(){
		new Navigation(map);
		new Highlight(map);
		new RaceClient({
			map: map,
			server: server,
			running: true
		})
	});
});

</script>

</head>

<body class="claro">

<div id="map" style="width:800px;height:600px;"></div>

</body>
</html>